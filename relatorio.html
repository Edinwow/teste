<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Registro de despesas | Relatório</title>
  <link rel="icon" href="invoice.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* keep existing styles (reused) */
    body { font-family: sans-serif; background: #202123; margin: 0; padding: 20px; color: #e2e2e2; }
    .container { margin: 0 auto; max-width:900px; }
    h2 { text-align: center; margin: 0; color: #ececf1; }
    form { max-width: 900px; display: flex; flex-direction: column; align-items: center; }
    .row { display:flex; gap:20px; flex-wrap:wrap; margin-top:8px; width:100%; justify-content:center; }
    label { font-weight:bold; margin-top:10px; display:block; color:#c7c7cc; }
    input, select, button { width:100%; box-sizing:border-box; padding:10px; margin-top:5px; border-radius:6px; font-size:1em; background-color:#343541; border:1px solid #444654; color:#e2e2e2; }
    button { background-color:#10a37f; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:15px; padding:12px; width:100%; max-width:320px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gerar relatório (PDF por categoria)</h2>
    <form onsubmit="event.preventDefault(); gerarPDFporCategoria();">
      <div class="row">
        <div>
          <label for="nomeSelect">Filtrar por pessoa</label>
          <select id="nomeSelect" class="name-inline"><option value="">Todos</option></select>
        </div>
        <div>
          <label for="dataInicio">Data inicial</label>
          <input type="date" id="dataInicio" />
        </div>
        <div>
          <label for="dataFim">Data final</label>
          <input type="date" id="dataFim" />
        </div>
      </div>

      <button type="submit">Gerar PDFs por categoria (ZIP)</button>
    </form>

    <div id="mensagem" style="margin-top:12px;"></div>
  </div>

  <!-- Botão circular voltar -->
  <a href="https://registrodespesas.vercel.app" id="btn-voltar" title="Voltar">
    <img src="receipt.svg" alt="Ícone Voltar" />
  </a>

<script>
  // URLs (fallback CSV) kept for backward compatibility
  const csvDadosUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvfKNijsXtDu3AKopOksK_9sEIpMI9O7sSCx3aX3Mo7IqspCy6mVI1jPKO939WxbKpnntTCfWoQu5R/pub?gid=0&single=true&output=csv';
  const csvFuncionariosUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvfKNijsXtDu3AKopOksK_9sEIpMI9O7sSCx3aX3Mo7IqspCy6mVI1jPKO939WxbKpnntTCfWoQu5R/pub?gid=1347748477&single=true&output=csv';

  let dadosExternos = []; // parsed remote CSV if any
  let funcionarios = [];
  let mapaFotos = {};

  // Carrega funcionários para select (tenta localStorage -> CSV)
  window.onload = async () => {
    // carregar lista nomes do localStorage (se existir)
    const despesasLocal = JSON.parse(localStorage.getItem('despesas') || '[]');
    const nomesSet = new Set(despesasLocal.map(d => d.nome).filter(Boolean));

    // tentar também carregar planilha de funcionários para imagens e nomes
    try {
      const r = await fetch(csvFuncionariosUrl);
      const txt = await r.text();
      const parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
      funcionarios = parsed.data;
      funcionarios.forEach(row => {
        const nome = row.nome?.trim();
        const img = row.imagem?.trim();
        if (nome) {
          mapaFotos[nome] = img || mapaFotos[nome] || 'https://via.placeholder.com/32';
          nomesSet.add(nome);
        }
      });
    } catch (e) {
      console.warn('Não foi possível carregar CSV de funcionários, prosseguindo com nomes locais.', e);
    }

    const select = document.getElementById('nomeSelect');
    select.innerHTML = '<option value="">Todos</option>';
    [...nomesSet].sort((a,b)=>a.localeCompare(b, 'pt-BR')).forEach(nome => {
      const opt = document.createElement('option');
      opt.value = nome;
      opt.textContent = nome;
      select.appendChild(opt);
    });

  };

  function parseDateBRtoISO(dstr) {
    if (!dstr) return '';
    if (dstr.indexOf('/') !== -1) {
      const p = dstr.split('/');
      return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
    }
    return dstr;
  }

  async function carregarDadosExternos() {
    try {
      const resp = await fetch(csvDadosUrl);
      const txt = await resp.text();
      const parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
      dadosExternos = parsed.data;
    } catch (e) {
      console.warn('Falha ao carregar dados externos:', e);
      dadosExternos = [];
    }
  }

  function obterTodasDespesas() {
    // Mescla despesas do localStorage com as externas (externas servent de fallback)
    const local = JSON.parse(localStorage.getItem('despesas') || '[]');
    const merged = [...local];

    // map external rows into same shape if keys exist and avoid duplicates by nota/data/valor/nome
    dadosExternos.forEach(row => {
      const item = {
        id: row.id || ('ext-' + (row.data || '') + '-' + (row.nome || '') + '-' + (row.valor || '')),
        nome: (row.nome || '').trim(),
        data: row.data ? row.data.trim() : '',
        grupo: row.grupo || row.categoria || row.categoria_despesa || '',
        forma_pagamento: row.forma_pagamento || row.forma || '',
        descricao: row.descricao || row.descricao || '',
        valor: row.valor || ''
      };
      // push if not present in local (simple check)
      if (!local.find(l => l.id === item.id)) merged.push(item);
    });

    return merged;
  }

  async function gerarPDFporCategoria() {
    document.getElementById('mensagem').textContent = 'Gerando PDFs...';
    await carregarDadosExternos();
    const nomeFiltro = document.getElementById('nomeSelect').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;

    let todas = obterTodasDespesas();

    // Normalizar data para ISO yyyy-mm-dd for comparison
    todas = todas.map(r => {
      return {...r, _dataISO: parseDateBRtoISO((r.data||'').trim()) || r.data || ''};
    });

    // Filtrar por nome e intervalo
    let filtradas = todas.filter(r => {
      if (nomeFiltro && r.nome.trim() !== nomeFiltro) return false;
      if (dataInicio && r._dataISO < dataInicio) return false;
      if (dataFim && r._dataISO > dataFim) return false;
      return true;
    });

    if (filtradas.length === 0) {
      document.getElementById('mensagem').textContent = '';
      alert('Nenhuma despesa encontrada para os filtros selecionados.');
      return;
    }

    // ordenar por data asc, nome asc
    filtradas.sort((a,b) => {
      if ((a._dataISO || '') < (b._dataISO || '')) return -1;
      if ((a._dataISO || '') > (b._dataISO || '')) return 1;
      return (a.nome || '').localeCompare(b.nome || '', 'pt-BR');
    });

    // agrupar por categoria (grupo)
    const grupos = {};
    filtradas.forEach(r => {
      const g = (r.grupo || 'Sem categoria').trim();
      grupos[g] = grupos[g] || [];
      grupos[g].push(r);
    });

    const { jsPDF } = window.jspdf;
    const zip = new JSZip();
    const margem = 12;
    const linhaAltura = 8;

    try {
      for (const [grupo, itens] of Object.entries(grupos)) {
        const pdf = new jsPDF({unit:'mm', format:'a4'});
        const pageHeight = pdf.internal.pageSize.getHeight();
        let y = 18;
        pdf.setFontSize(14);
        pdf.setFont('helvetica','bold');
        pdf.text(`Recibo - Categoria: ${grupo}`, margem, 14);

        pdf.setFontSize(11);
        pdf.setFont('helvetica','normal');
        // cabeçalho da tabela
        pdf.text('Nome', margem, y);
        pdf.text('Data', 80, y);
        pdf.text('Descrição', 105, y);
        pdf.text('Valor', 175, y, {align: 'right'});
        y += linhaAltura;

        let total = 0;
        for (const it of itens) {
          if (y > pageHeight - 20) {
            pdf.addPage();
            y = 18;
          }
          const nome = (it.nome || '').toString();
          const data = (it.data || it._dataISO || '').toString();
          const desc = (it.descricao || '').toString();
          const valorStr = (it.valor || '').toString().replace(/[R$\\s\\.]/g,'').replace(',','.') || '0';
          let valorNum = parseFloat(valorStr);
          if (isNaN(valorNum)) valorNum = 0;
          total += valorNum;

          // ajustar textos longos (descricao) com split simples
          const descricaoWrapped = pdf.splitTextToSize(desc, 60);
          const nomeWrapped = pdf.splitTextToSize(nome, 24);

          // imprimir nome (até 2 linhas), descrição (pode quebrar), data, valor
          pdf.text(nomeWrapped, margem, y);
          pdf.text(data, 80, y);
          pdf.text(descricaoWrapped, 105, y);
          pdf.text('R$ ' + valorNum.toFixed(2).replace('.',','), 195, y, {align:'right'});
          y += Math.max(linhaAltura * Math.max(nomeWrapped.length, descricaoWrapped.length), linhaAltura);
        }

        // Total na última linha
        if (y > pageHeight - 20) {
          pdf.addPage();
          y = 18;
        }
        pdf.setFont('helvetica','bold');
        pdf.text('Total da categoria:', 105, y + 6);
        pdf.text('R$ ' + total.toFixed(2).replace('.',','), 195, y + 6, {align:'right'});

        // adicionar ao zip
        const pdfBlob = pdf.output('blob');
        zip.file(`relatorio_${grupo.replace(/\\s+/g,'_')}.pdf`, pdfBlob);
      }

      // gerar ZIP
      const zipBlob = await zip.generateAsync({type:'blob'});
      saveAs(zipBlob, `relatorios_por_categoria_${new Date().toISOString().slice(0,10)}.zip`);
      document.getElementById('mensagem').textContent = '';
    } catch (e) {
      console.error(e);
      alert('Ocorreu um erro durante a geração dos PDFs. Verifique o console para mais detalhes.');
      document.getElementById('mensagem').textContent = '';
    }
  }
</script>

</body>
</html>
