<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Gastos ‚Äî Moto üèçÔ∏è</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --muted:#6b7280; --accent:#0f172a;
      --glass: rgba(15,23,42,0.03);
      font-family: Inter, system-ui, -apple-system, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent)}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    .card.big{grid-column:span 2}
    .ind{display:flex;justify-content:space-between;align-items:center}
    .ind .val{font-size:18px;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;align-items:center}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent}
    canvas{width:100% !important;height:260px !important}
    small{color:var(--muted)}
    .row{display:flex;gap:12px}
    .metric{display:flex;flex-direction:column;gap:6px}
    .metric .k{font-weight:700;font-size:16px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.card.big{grid-column:span 1}}
  </style>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üìä Painel de Gastos ‚Äî Minha Moto</h1>
        <p class="lead">Design minimalista e interativo. Mostra indicadores por categoria e gr√°ficos temporais.</p>
      </div>
      <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end">
        <small>Fonte: Google Sheets (online)</small>
        <small id="status" class="muted">Carregando dados‚Ä¶</small>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Filtrar categoria</div>
            <div class="controls" style="margin-top:6px">
              <select id="categorySelect"></select>
              <button id="resetBtn">üîÅ Reset</button>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">Per√≠odo</div>
            <div id="period" style="font-weight:700">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="ind">
          <div>
            <div class="muted">Total gasto</div>
            <div class="val" id="totalSpent">R$ 0,00</div>
            <small class="muted">(soma de Valor/Valor total quando aplic√°vel)</small>
          </div>
          <div style="text-align:right">
            <div class="muted">Entradas</div>
            <div class="val" id="countEntries">0</div>
            <small class="muted">registros</small>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="ind">
          <div>
            <div class="muted">√öltimo gasto</div>
            <div id="lastEntry" class="val">‚Äî</div>
            <small class="muted" id="lastDesc">‚Äî</small>
          </div>
          <div style="text-align:right">
            <div class="muted">M√©dia por m√™s</div>
            <div id="avgPerMonth" class="val">R$ 0,00</div>
            <small class="muted">(m√©dia simples)</small>
          </div>
        </div>
      </div>

      <div class="card big">
        <div class="muted">üìà Gastos ao longo do tempo</div>
        <canvas id="timeChart"></canvas>
      </div>

      <div class="card">
        <div class="muted">üí∏ Distribui√ß√£o por categoria</div>
        <canvas id="pieChart"></canvas>
      </div>

      <div class="card">
        <div class="muted" id="gasTitle">üîß Indicadores da categoria</div>
        <div style="margin-top:10px" id="categoryMetrics">
          <div class="row">
            <div class="metric">
              <small class="muted">Total</small>
              <div class="k" id="catTotal">R$ 0,00</div>
            </div>
            <div class="metric">
              <small class="muted">Contagem</small>
              <div class="k" id="catCount">0</div>
            </div>
            <div class="metric">
              <small class="muted">M√©dia</small>
              <div class="k" id="catAvg">R$ 0,00</div>
            </div>
          </div>
          <div style="margin-top:10px" id="gasExtra" class="muted"></div>
        </div>
      </div>

    </div>

    <footer>
      <div>üí° Dica: selecione uma categoria para ver detalhes. Se houver bloqueio CORS ao buscar a planilha, baixe o CSV e abra este arquivo localmente (arraste-o para o navegador).</div>
    </footer>
  </div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXYUEcvzBEg1AQ5754QmQUGb73zVzI6LEI-WmdAxHx1N2_5ZGLPP0DobNZQW1-IUk1qZVOiu0SZ965/pub?gid=817947441&single=true&output=csv';

let raw = [];
let parsed = [];
let charts = {};

function fmtBR(x){
  if(x===null||x===undefined||isNaN(x)) return 'R$ 0,00';
  return x.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

function parseNumber(v){
  if(!v) return NaN;
  // replace comma decimal
  v = String(v).replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(v);
  return isNaN(n)?NaN:n;
}

function loadData(){
  document.getElementById('status').textContent = 'Buscando CSV online‚Ä¶';
  Papa.parse(CSV_URL, {
    download:true, header:true, skipEmptyLines:true,
    complete: function(res){
      raw = res.data;
      document.getElementById('status').textContent = 'Dados carregados ‚Äî processando‚Ä¶';
      processData();
    },
    error:function(err){
      document.getElementById('status').textContent = 'Erro ao carregar CSV: '+err.message;
    }
  });
}

function processData(){
  // Normalize headers: Categoria,Data,Chave,Valor
  parsed = raw.map(r=>({
    Categoria:(r.Categoria||r.categoria||r.CATEGORY||r.Category||'').trim(),
    Data:(r.Data||r.data||'').trim(),
    Chave:(r.Chave||r.chave||r.Key||'').trim(),
    Valor:(r.Valor||r.valor||r.Value||'').trim()
  })).filter(r=>r.Categoria||r.Data||r.Valor);

  // parse dates
  parsed.forEach(r=>{
    // try dd/mm/yyyy or yyyy-mm-dd
    let d = r.Data;
    let date = null;
    if(/\d{2}\/\d{2}\/\d{4}/.test(d)){
      const [dd,mm,yy]=d.split('/'); date = new Date(`${yy}-${mm}-${dd}T00:00:00`);
    } else {
      const t = Date.parse(d);
      if(!isNaN(t)) date = new Date(t);
    }
    r._date = date;
    r._valorNum = parseNumber(r.Valor);
  });

  // sort by date
  parsed = parsed.filter(r=>r._date).sort((a,b)=>a._date - b._date);

  setupUI();
}

function setupUI(){
  const cats = Array.from(new Set(parsed.map(r=>r.Categoria))).sort();
  const sel = document.getElementById('categorySelect'); sel.innerHTML='';
  const optAll = document.createElement('option'); optAll.value='__all'; optAll.textContent='‚Äî Todas as categorias ‚Äî'; sel.appendChild(optAll);
  cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});

  document.getElementById('resetBtn').addEventListener('click',()=>{sel.value='__all'; updateViews();});
  sel.addEventListener('change',updateViews);

  // initial charts
  createCharts();
  updateViews();
  document.getElementById('status').textContent = 'Pronto ‚úÖ';
}

function aggregateByMonth(entries){
  const map = new Map();
  entries.forEach(e=>{
    const k = e._date.getFullYear() + '-' + String(e._date.getMonth()+1).padStart(2,'0');
    if(!map.has(k)) map.set(k,0);
    map.set(k, map.get(k) + (isFinite(e._valorNum)?e._valorNum:0));
  });
  const arr = Array.from(map.entries()).sort();
  return arr.map(([k,v])=>({month:k, value:v}));
}

function createCharts(){
  const tctx = document.getElementById('timeChart').getContext('2d');
  charts.time = new Chart(tctx,{type:'line',data:{labels:[],datasets:[{label:'Gasto (R$)',data:[] ,tension:0.25,fill:true}]},options:{plugins:{legend:{display:false}},scales:{x:{type:'category'},y:{beginAtZero:true}}}});

  const pctx = document.getElementById('pieChart').getContext('2d');
  charts.pie = new Chart(pctx,{type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{position:'bottom'}}}});
}

function updateViews(){
  const cat = document.getElementById('categorySelect').value;
  const entries = cat==='__all'? parsed : parsed.filter(r=>r.Categoria===cat);

  // basic indicators
  const total = entries.reduce((s,e)=>(s + (isFinite(e._valorNum)?e._valorNum:0)),0);
  document.getElementById('totalSpent').textContent = fmtBR(total);
  document.getElementById('countEntries').textContent = entries.length;

  const last = entries.slice().reverse().find(e=>isFinite(e._valorNum));
  document.getElementById('lastEntry').textContent = last? fmtBR(last._valorNum) : '‚Äî';
  document.getElementById('lastDesc').textContent = last? (last.Data + ' ‚Äî ' + (last.Chave||'') ) : '‚Äî';

  // period
  if(parsed.length){
    const d0 = parsed[0]._date; const d1 = parsed[parsed.length-1]._date;
    document.getElementById('period').textContent = d0.toLocaleDateString('pt-BR') + ' ‚Üí ' + d1.toLocaleDateString('pt-BR');
  }

  // avg per month
  const months = new Set(entries.map(e=> e._date.getFullYear()+'-'+(e._date.getMonth()+1)));
  const avgMonth = months.size? total / months.size : 0;
  document.getElementById('avgPerMonth').textContent = fmtBR(avgMonth);

  // category metrics
  document.getElementById('catTotal').textContent = fmtBR(total);
  document.getElementById('catCount').textContent = entries.length;
  document.getElementById('catAvg').textContent = fmtBR(entries.length? total/entries.length : 0);

  // pie chart: totals per category (global)
  const totalsByCat = {};
  parsed.forEach(e=>{ const v = isFinite(e._valorNum)?e._valorNum:0; totalsByCat[e.Categoria] = (totalsByCat[e.Categoria]||0)+v });
  const labels = Object.keys(totalsByCat).sort((a,b)=>totalsByCat[b]-totalsByCat[a]);
  charts.pie.data.labels = labels;
  charts.pie.data.datasets[0].data = labels.map(l=>totalsByCat[l]);
  charts.pie.update();

  // time chart: monthly aggregated for selected entries
  const monthly = aggregateByMonth(entries);
  charts.time.data.labels = monthly.map(m=>m.month);
  charts.time.data.datasets[0].data = monthly.map(m=>m.value);
  charts.time.update();

  // gas-specific extras
  const gasExtra = document.getElementById('gasExtra'); gasExtra.innerHTML='';
  document.getElementById('gasTitle').textContent = 'üîß Indicadores da categoria' + (cat && cat!=='__all' ? ' ‚Äî ' + cat : '');
  if((cat==='Gasolina' || cat.toLowerCase().includes('gasolina'))){
    // compute km differences and cost per km when possible
    const kmEntries = parsed.filter(e=>e.Categoria.toLowerCase().includes('gasolina') && e.Chave.toLowerCase().includes('quilometragem') && isFinite(e._valorNum));
    const fills = parsed.filter(e=>e.Categoria.toLowerCase().includes('gasolina') && (e.Chave.toLowerCase().includes('valor total')|| e.Chave.toLowerCase().includes('valor')));
    // build array of km by date
    const kms = parsed.filter(e=>e.Categoria.toLowerCase().includes('gasolina') && e.Chave.toLowerCase().includes('quilometragem')).map(e=>({date:e._date,km:e._valorNum})).sort((a,b)=>a.date-b.date);
    // pair successive km to estimate distance
    let distances = [];
    for(let i=1;i<kms.length;i++){ const d = kms[i].km - kms[i-1].km; if(isFinite(d) && d>0) distances.push(d); }
    // try match fills to nearest km date within 3 days
    let costPerKm = [];
    fills.forEach(f=>{
      const nearest = kms.reduce((acc,k)=>{
        const diff = Math.abs(k.date - f._date);
        if(diff < acc.diff) return {k:k,diff:diff}; return acc;
      },{k:null,diff:Infinity});
      if(nearest.k && nearest.k.km && isFinite(f._valorNum)){
        costPerKm.push({date:f._date, cost:f._valorNum, km:nearest.k.km});
      }
    });

    const avgDistance = distances.length? (distances.reduce((s,x)=>s+x,0)/distances.length):NaN;
    const avgCostPerKm = (distances.length && parsed.length)? (()=>{
      // approximate: sum of fill cost / sum distances (match by order)
      const fillCosts = fills.filter(f=>isFinite(f._valorNum)).map(f=>f._valorNum);
      const used = Math.min(fillCosts.length, distances.length);
      if(used===0) return NaN;
      const costSum = fillCosts.slice(-used).reduce((s,x)=>s+x,0);
      const distSum = distances.slice(-used).reduce((s,x)=>s+x,0);
      return costSum/distSum;
    })():NaN;

    const el = document.createElement('div');
    el.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <div><small class=\"muted\">Dist√¢ncia m√©dia entre abastecimentos</small><div class=\"k\">${isFinite(avgDistance)? Math.round(avgDistance)+' km':'‚Äî'}</div></div>
        <div><small class=\"muted\">Custo m√©dio por km (estimado)</small><div class=\"k\">${isFinite(avgCostPerKm)? fmtBR(avgCostPerKm):'‚Äî'}</div></div>
        <div><small class=\"muted\">Abastecimentos registrados</small><div class=\"k\">${fills.length}</div></div>
      </div>`;
    gasExtra.appendChild(el);
  }
}

// on load
window.addEventListener('load',()=>{ loadData(); });

</script>
</body>
</html>
