<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gastos da Moto v2</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --text-secondary-color: #6c757d;
            --accent-color: #007bff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background-color: var(--card-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            text-align: center;
        }

        .kpi-card .label {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .kpi-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .kpi-card .value .unit {
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--text-secondary-color);
        }

        .chart-card {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .chart-card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .main-charts-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary-color);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }
        .tab-link.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .table-card {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow-x: auto;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .table-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .table-header input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--bg-color); font-weight: 600; }
        tbody tr:hover { background-color: #f1f3f5; }

        @media (max-width: 992px) {
            .main-charts-grid { grid-template-columns: 1fr; }
        }
        
         @media (max-width: 768px) {
            body { padding: 10px; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Painel de Gastos da Moto</h1>
        </header>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'tab-overview')">Visão Geral</button>
            <button class="tab-link" onclick="openTab(event, 'tab-gasolina')">Gasolina</button>
            <button class="tab-link" onclick="openTab(event, 'tab-oleo')">Óleo</button>
            <button class="tab-link" onclick="openTab(event, 'tab-infracao')">Infração</button>
            <button class="tab-link" onclick="openTab(event, 'tab-outros')">Outros</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <section class="kpi-grid">
                <div class="kpi-card">
                    <div class="label">Custo Total</div>
                    <div class="value" id="total-cost">R$ 0,00</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Consumo Médio</div>
                    <div class="value" id="avg-consumption">0 <span class="unit">km/L</span></div>
                </div>
            </section>

            <section class="main-charts-grid">
                <div class="chart-card">
                    <h2>Gastos por Categoria</h2>
                    <div id="category-chart"></div>
                </div>
                <div class="chart-card">
                    <h2>Gastos Mensais (Todas as Categorias)</h2>
                    <div id="monthly-spending-chart"></div>
                </div>
            </section>
        </div>

        <div id="tab-gasolina" class="tab-content">
            <h2>Detalhes de Abastecimento</h2>
            <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Gasto Total com Gasolina</div><div class="value" id="gas-total-cost"></div></div>
                <div class="kpi-card"><div class="label">Total de Litros</div><div class="value" id="gas-total-liters"></div></div>
                <div class="kpi-card"><div class="label">Preço Médio / Litro</div><div class="value" id="gas-avg-price"></div></div>
                <div class="kpi-card"><div class="label">Preço Mais Baixo</div><div class="value" id="gas-min-price"></div></div>
                <div class="kpi-card"><div class="label">Preço Mais Alto</div><div class="value" id="gas-max-price"></div></div>
            </section>
            <section class="chart-card">
                 <h2>Evolução do Preço da Gasolina (R$/Litro)</h2>
                <div id="fuel-price-chart"></div>
            </section>
        </div>

        <div id="tab-oleo" class="tab-content">
            <h2>Detalhes de Troca de Óleo</h2>
            <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Gasto Total com Óleo</div><div class="value" id="oleo-total-cost"></div></div>
                <div class="kpi-card"><div class="label">Nº de Trocas</div><div class="value" id="oleo-count"></div></div>
                <div class="kpi-card"><div class="label">Custo Médio por Troca</div><div class="value" id="oleo-avg-cost"></div></div>
                <div class="kpi-card"><div class="label">KM Médio entre Trocas</div><div class="value" id="oleo-avg-km"></div></div>
            </section>
        </div>

        <div id="tab-infracao" class="tab-content">
            <h2>Detalhes de Infrações</h2>
            <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Custo Total</div><div class="value" id="infracao-total-cost"></div></div>
                <div class="kpi-card"><div class="label">Nº de Infrações</div><div class="value" id="infracao-count"></div></div>
                <div class="kpi-card"><div class="label">Total de Pontos</div><div class="value" id="infracao-total-pontos"></div></div>
            </section>
             <section class="table-card">
                <h2>Lista de Infrações</h2>
                <table id="infracoes-table">
                    <thead><tr><th>Data</th><th>Motivo</th><th>Tipo</th><th>Pontos</th><th>Valor</th></tr></thead>
                    <tbody id="infracoes-table-body"></tbody>
                </table>
            </section>
        </div>
        
        <div id="tab-outros" class="tab-content">
            <h2>Detalhes de Outros Gastos</h2>
            <section class="kpi-grid">
                 <div class="kpi-card"><div class="label">Gasto Total</div><div class="value" id="outros-total-cost"></div></div>
            </section>
             <section class="chart-card">
                 <h2>Top 10 Maiores Gastos</h2>
                <div id="outros-top-chart"></div>
            </section>
        </div>

    </div>

    <script>
        const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXYUEcvzBEg1AQ5754QmQUGb73zVzI6LEI-WmdAxHx1N2_5ZGLPP0DobNZQW1-IUk1qZVOiu0SZ965/pub?gid=817947441&single=true&output=csv';

        // --- UTILITY FUNCTIONS ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatNumber = (value, dec = 2) => value.toLocaleString('pt-BR', { minimumFractionDigits: dec, maximumFractionDigits: dec });

        // --- MAIN LOGIC ---
        document.addEventListener("DOMContentLoaded", async function() {
            try {
                const response = await fetch(dataUrl);
                const csvText = await response.text();
                const rawData = parseCSV(csvText);
                
                processAndRenderDashboard(rawData);
            } catch (error) {
                console.error("Erro ao buscar ou processar os dados:", error);
                document.querySelector('.container').innerHTML = '<h1>Erro ao carregar os dados. Verifique o console para mais detalhes.</h1>';
            }
        });

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).slice(1); // Ignora o cabeçalho
            return lines.map(line => {
                const values = line.split(',');
                return {
                    Categoria: values[0],
                    Data: values[1],
                    Chave: values[2],
                    Valor: values[3]
                };
            }).filter(d => d.Categoria && d.Data && d.Chave && d.Valor); // Filtra linhas vazias
        }

        function processAndRenderDashboard(rawData) {
            // --- DATA PROCESSING ---
            const parseDate = (dateStr) => {
                if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return null;
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            };
            const parseValue = (valueStr) => parseFloat(String(valueStr).replace(/\./g, '').replace(',', '.'));

            const processedData = rawData
                .filter(d => d.Chave !== "Moto") // Remove a compra da moto
                .map(d => {
                    const valueStr = d.Valor;
                    const isNumeric = !isNaN(parseValue(valueStr));
                    return {
                        ...d,
                        date: parseDate(d.Data),
                        value: isNumeric ? parseValue(valueStr) : valueStr,
                        isCost: ["Valor total", "Valor"].includes(d.Chave) || d.Categoria === 'Outros'
                    }
                }).filter(d => d.date); // Remove entradas com data inválida

            // --- OVERVIEW TAB ---
            const totalCost = processedData
                .filter(d => d.isCost)
                .reduce((acc, curr) => acc + curr.value, 0);
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);

            const costsByCategory = processedData
                .filter(d => d.isCost)
                .reduce((acc, curr) => {
                    acc[curr.Categoria] = (acc[curr.Categoria] || 0) + curr.value;
                    return acc;
                }, {});

            const monthlySpending = processedData
                .filter(d => d.isCost)
                .reduce((acc, curr) => {
                    const month = `${curr.date.getFullYear()}-${(curr.date.getMonth() + 1).toString().padStart(2, '0')}`;
                    acc[month] = (acc[month] || 0) + curr.value;
                    return acc;
                }, {});
            
            // --- FUEL CONSUMPTION CALCULATION ---
            const fuelStops = {};
            processedData
                .filter(d => d.Categoria === 'Gasolina')
                .forEach(d => {
                    const dateStr = d.Data;
                    if (!fuelStops[dateStr]) fuelStops[dateStr] = { date: d.date };
                    if (d.Chave === 'Quilometragem') fuelStops[dateStr].km = d.value;
                    if (d.Chave === 'Valor total') fuelStops[dateStr].totalValue = d.value;
                    if (d.Chave === 'Valor do litro') fuelStops[dateStr].pricePerLiter = d.value;
                });
            
            const validFuelStops = Object.values(fuelStops)
                .filter(d => d.km && d.totalValue && d.pricePerLiter && d.km < 20000)
                .sort((a, b) => a.date - b.date);

            const consumptionData = [];
            for (let i = 1; i < validFuelStops.length; i++) {
                const distance = validFuelStops[i].km - validFuelStops[i-1].km;
                const liters = validFuelStops[i].totalValue / validFuelStops[i].pricePerLiter;
                if (distance > 0 && liters > 0) {
                    const kpl = distance / liters;
                    if(kpl > 10 && kpl < 100) consumptionData.push(kpl);
                }
            }
            
            const avgConsumption = consumptionData.length > 0
                ? consumptionData.reduce((a, b) => a + b, 0) / consumptionData.length
                : 0;
            document.getElementById('avg-consumption').innerHTML = `${formatNumber(avgConsumption, 2)} <span class="unit">km/L</span>`;

            // --- GASOLINA TAB ---
            const gasolinaData = processedData.filter(d => d.Categoria === 'Gasolina');
            const gasTotalCost = validFuelStops.reduce((acc, curr) => acc + curr.totalValue, 0);
            const gasTotalLiters = validFuelStops.reduce((acc, curr) => acc + (curr.totalValue / curr.pricePerLiter), 0);
            const gasAvgPrice = gasTotalCost / gasTotalLiters;
            const prices = validFuelStops.map(d => d.pricePerLiter);
            document.getElementById('gas-total-cost').textContent = formatCurrency(gasTotalCost);
            document.getElementById('gas-total-liters').innerHTML = `${formatNumber(gasTotalLiters, 2)} <span class="unit">L</span>`;
            document.getElementById('gas-avg-price').textContent = formatCurrency(gasAvgPrice);
            document.getElementById('gas-min-price').textContent = formatCurrency(Math.min(...prices));
            document.getElementById('gas-max-price').textContent = formatCurrency(Math.max(...prices));
            
            // --- OLEO TAB ---
            const oleoCosts = processedData.filter(d => d.Categoria === 'Óleo' && d.Chave === 'Valor');
            const oleoKms = processedData.filter(d => d.Categoria === 'Óleo' && d.Chave === 'Quilometragem').sort((a, b) => a.date - b.date);
            const oleoTotalCost = oleoCosts.reduce((acc, curr) => acc + curr.value, 0);
            const oleoCount = oleoCosts.length;
            const oleoAvgCost = oleoTotalCost / oleoCount;
            const kmDiffs = [];
            for (let i = 1; i < oleoKms.length; i++) {
                kmDiffs.push(oleoKms[i].value - oleoKms[i-1].value);
            }
            const oleoAvgKm = kmDiffs.length > 0 ? kmDiffs.reduce((a, b) => a + b, 0) / kmDiffs.length : 0;
            document.getElementById('oleo-total-cost').textContent = formatCurrency(oleoTotalCost);
            document.getElementById('oleo-count').textContent = oleoCount;
            document.getElementById('oleo-avg-cost').textContent = formatCurrency(oleoAvgCost);
            document.getElementById('oleo-avg-km').innerHTML = `${formatNumber(oleoAvgKm, 0)} <span class="unit">km</span>`;

            // --- INFRACAO TAB ---
            const infracaoData = {};
            processedData.filter(d => d.Categoria === 'Infração').forEach(d => {
                const date = d.Data;
                if (!infracaoData[date]) infracaoData[date] = {Data: date};
                infracaoData[date][d.Chave] = d.value;
            });
            const infracoes = Object.values(infracaoData);
            const infracaoTotalCost = infracoes.reduce((acc, curr) => acc + (curr.Valor || 0), 0);
            const infracaoTotalPontos = infracoes.reduce((acc, curr) => acc + (parseInt(curr.Pontos) || 0), 0);
            document.getElementById('infracao-total-cost').textContent = formatCurrency(infracaoTotalCost);
            document.getElementById('infracao-count').textContent = infracoes.length;
            document.getElementById('infracao-total-pontos').textContent = infracaoTotalPontos;
            const tableBody = document.getElementById('infracoes-table-body');
            infracoes.forEach(i => {
                let row = tableBody.insertRow();
                row.insertCell(0).textContent = i.Data;
                row.insertCell(1).textContent = i.Motivo;
                row.insertCell(2).textContent = i.Tipo;
                row.insertCell(3).textContent = i.Pontos;
                row.insertCell(4).textContent = formatCurrency(i.Valor);
            });

            // --- OUTROS TAB ---
            const outrosData = processedData.filter(d => d.Categoria === 'Outros');
            const outrosTotalCost = outrosData.reduce((acc, curr) => acc + curr.value, 0);
            document.getElementById('outros-total-cost').textContent = formatCurrency(outrosTotalCost);
            const top10Outros = outrosData.sort((a,b) => b.value - a.value).slice(0, 10);

            // --- RENDER CHARTS ---
            renderCharts(costsByCategory, monthlySpending, validFuelStops, top10Outros);
        }
        
        function renderCharts(costsByCategory, monthlySpending, validFuelStops, top10Outros) {
            const chartOptions = {
                colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'],
                chart: { fontFamily: 'Inter, sans-serif', toolbar: { show: false } },
                stroke: { width: 2, curve: 'smooth' },
                markers: { size: 4 },
                tooltip: { theme: 'light', x: { format: 'dd MMM yyyy' } },
                grid: { borderColor: '#e9ecef' }
            };

            // Overview - Category Chart
            new ApexCharts(document.querySelector("#category-chart"), {
                series: Object.values(costsByCategory),
                labels: Object.keys(costsByCategory),
                chart: { type: 'donut', height: 350 },
                colors: chartOptions.colors,
                legend: { position: 'bottom' }
            }).render();

            // Overview - Monthly Spending
            const sortedMonths = Object.keys(monthlySpending).sort();
            new ApexCharts(document.querySelector("#monthly-spending-chart"), {
                ...chartOptions,
                series: [{ name: 'Gastos', data: sortedMonths.map(m => monthlySpending[m]) }],
                chart: { type: 'area', height: 350, ...chartOptions.chart },
                xaxis: { categories: sortedMonths, labels: { style: { colors: '#6c757d' } } },
                yaxis: { labels: { style: { colors: '#6c757d' }, formatter: (val) => formatCurrency(val) } },
                dataLabels: { enabled: false },
                tooltip: { ...chartOptions.tooltip, y: { formatter: (val) => formatCurrency(val) } }
            }).render();

            // Gasolina - Fuel Price
            new ApexCharts(document.querySelector("#fuel-price-chart"), {
                ...chartOptions,
                series: [{ name: 'Valor/litro', data: validFuelStops.map(d => ({ x: d.date.getTime(), y: d.pricePerLiter })) }],
                chart: { type: 'line', height: 350, ...chartOptions.chart },
                xaxis: { type: 'datetime', labels: { style: { colors: '#6c757d' } } },
                yaxis: { labels: { style: { colors: '#6c757d' }, formatter: (val) => formatCurrency(val) } },
                tooltip: { ...chartOptions.tooltip, y: { formatter: (val) => formatCurrency(val) } }
            }).render();
            
            // Outros - Top 10
            new ApexCharts(document.querySelector("#outros-top-chart"), {
                ...chartOptions,
                 series: [{ name: 'Custo', data: top10Outros.map(item => item.value) }],
                 chart: { type: 'bar', height: 350 },
                 plotOptions: { bar: { borderRadius: 4, horizontal: true, } },
                 dataLabels: { enabled: false },
                 xaxis: { categories: top10Outros.map(item => item.Chave), labels: { formatter: (val) => formatCurrency(val) } },
                 tooltip: { y: { formatter: (val) => formatCurrency(val) } }
            }).render();
        }

    </script>
</body>
</html>