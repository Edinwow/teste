<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gastos da Moto v4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #2c3e50;
            --text-secondary-color: #7f8c8d;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #e0e5e9;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .spinner {
            width: 50px; height: 50px; border-radius: 50%; border: 6px solid var(--border-color);
            border-top-color: var(--accent-color); animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .tab-link {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: 2px solid var(--border-color);
            background: var(--card-bg-color);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary-color);
            border-radius: 50px;
            transition: all 0.2s ease-in-out;
        }
        .tab-link:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .tab-link.active {
            background-color: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .page-header h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .kpi-card .label {
            font-size: 1rem;
            color: var(--text-secondary-color);
            margin-bottom: 0.5rem;
        }
        .kpi-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }
        .kpi-card .value .unit {
            font-size: 1rem;
            font-weight: 400;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .chart-card, .table-card {
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .chart-card h3, .table-card h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; color: var(--text-secondary-color); font-size: 0.85rem; text-transform: uppercase; }
        tbody tr:hover { background-color: #f8fafc; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>
    
    <div class="container">
        <header>
            <h1><span>üèçÔ∏è</span> Painel de Gastos da Moto</h1>
        </header>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'tab-overview')">üìä Vis√£o Geral</button>
            <button class="tab-link" onclick="openTab(event, 'tab-gasolina')">‚õΩ Gasolina</button>
            <button class="tab-link" onclick="openTab(event, 'tab-oleo')">üíß √ìleo</button>
            <button class="tab-link" onclick="openTab(event, 'tab-infracao')">üìÑ Infra√ß√£o</button>
            <button class="tab-link" onclick="openTab(event, 'tab-outros')">üõí Outros</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <section class="kpi-grid">
                <div class="kpi-card">
                    <div class="label">üí∞ Custo Total</div>
                    <div class="value" id="total-cost">R$ 0,00</div>
                </div>
                <div class="kpi-card">
                    <div class="label">üß≠ Consumo M√©dio</div>
                    <div class="value" id="avg-consumption">0 <span class="unit">km/L</span></div>
                </div>
            </section>
            <div class="chart-grid">
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <h3>Gastos Mensais (Todas as Categorias)</h3>
                    <div id="monthly-spending-chart"></div>
                </div>
                 <div class="chart-card">
                    <h3>Gastos por Categoria</h3>
                    <div id="category-chart"></div>
                </div>
            </div>
        </div>

        <div id="tab-gasolina" class="tab-content">
            <div class="page-header"><h2>An√°lise de Gasolina</h2></div>
            <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Gasto Total</div><div class="value" id="gas-total-cost"></div></div>
                <div class="kpi-card"><div class="label">Total de Litros</div><div class="value" id="gas-total-liters"></div></div>
                <div class="kpi-card"><div class="label">Pre√ßo M√©dio / Litro</div><div class="value" id="gas-avg-price"></div></div>
            </section>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3>Evolu√ß√£o do Pre√ßo da Gasolina (R$/Litro)</h3>
                    <div id="fuel-price-chart"></div>
                </div>
                <div class="chart-card">
                    <h3>Evolu√ß√£o do Consumo (Km/L)</h3>
                    <div id="fuel-consumption-chart"></div>
                </div>
            </div>
        </div>
        
        <div id="tab-oleo" class="tab-content">
             <div class="page-header"><h2>An√°lise de Trocas de √ìleo</h2></div>
             <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Gasto Total</div><div class="value" id="oleo-total-cost"></div></div>
                <div class="kpi-card"><div class="label">N¬∫ de Trocas</div><div class="value" id="oleo-count"></div></div>
                <div class="kpi-card"><div class="label">Custo M√©dio / Troca</div><div class="value" id="oleo-avg-cost"></div></div>
                <div class="kpi-card"><div class="label">KM M√©dio / Troca</div><div class="value" id="oleo-avg-km"></div></div>
            </section>
             <div class="table-card">
                <h3>Hist√≥rico de Trocas</h3>
                <table id="oleo-table">
                    <thead><tr><th>Data</th><th>KM no Od√¥metro</th><th>KM Rodados desde a √öltima Troca</th></tr></thead>
                    <tbody id="oleo-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-infracao" class="tab-content">
             <div class="page-header"><h2>An√°lise de Infra√ß√µes</h2></div>
             <section class="kpi-grid">
                <div class="kpi-card"><div class="label">Custo Total</div><div class="value" id="infracao-total-cost"></div></div>
                <div class="kpi-card"><div class="label">N¬∫ de Infra√ß√µes</div><div class="value" id="infracao-count"></div></div>
                <div class="kpi-card"><div class="label">Total de Pontos</div><div class="value" id="infracao-total-pontos"></div></div>
            </section>
             <div class="table-card">
                <h3>Lista de Infra√ß√µes</h3>
                <table id="infracoes-table">
                    <thead><tr><th>Data</th><th>Motivo</th><th>Tipo</th><th>Pontos</th><th>Valor</th></tr></thead>
                    <tbody id="infracoes-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="tab-outros" class="tab-content">
            <div class="page-header"><h2>An√°lise de Outros Gastos</h2></div>
             <section class="kpi-grid">
                 <div class="kpi-card"><div class="label">Gasto Total</div><div class="value" id="outros-total-cost"></div></div>
            </section>
             <div class="chart-card">
                 <h3>Top 10 Maiores Gastos</h3>
                <div id="outros-top-chart"></div>
            </div>
        </div>
    </div>
    
    <script>
        const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXYUEcvzBEg1AQ5754QmQUGb73zVzI6LEI-WmdAxHx1N2_5ZGLPP0DobNZQW1-IUk1qZVOiu0SZ965/pub?gid=817947441&single=true&output=csv';

        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(p => p.classList.remove('active'));
            document.querySelectorAll(".tab-link").forEach(l => l.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatNumber = (value, dec = 2) => value.toLocaleString('pt-BR', { minimumFractionDigits: dec, maximumFractionDigits: dec });

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch(dataUrl);
                const csvText = await response.text();
                const rawData = parseCSV(csvText);
                processAndRenderDashboard(rawData);
            } catch (error) {
                console.error("Erro ao buscar ou processar os dados:", error);
                document.body.innerHTML = '<h1>Erro ao carregar os dados. Verifique o console.</h1>';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        });
        
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).slice(1);
            const records = [];
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            lines.forEach(line => {
                if (!line.trim()) return;
                const values = line.split(regex).map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length >= 4) {
                    records.push({ Categoria: values[0], Data: values[1], Chave: values[2], Valor: values[3] });
                }
            });
            return records.filter(d => d.Categoria && d.Data && d.Chave && d.Valor);
        }

        function processAndRenderDashboard(rawData) {
            const parseDate = (d) => {
                if (!/^\d{2}\/\d{2}\/\d{4}$/.test(d)) return null;
                const [day, month, year] = d.split('/');
                return new Date(year, month - 1, day);
            };
            const parseValue = (v) => parseFloat(String(v).replace(/\./g, '').replace(',', '.'));

            const processedData = rawData.filter(d => d.Chave !== "Moto").map(d => {
                const val = d.Valor;
                const isNum = !isNaN(parseValue(val));
                return { ...d, date: parseDate(d.Data), value: isNum ? parseValue(val) : val, isCost: ["Valor total", "Valor"].includes(d.Chave) || d.Categoria === 'Outros' };
            }).filter(d => d.date);

            // --- CALCULATIONS ---
            // Safeguard: use (Number(c.value) || 0) to prevent errors from non-numeric values
            const totalCost = processedData.filter(d => d.isCost).reduce((a, c) => a + (Number(c.value) || 0), 0);
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            
            const costsByCategory = processedData.filter(d => d.isCost).reduce((a, c) => ({...a, [c.Categoria]: (a[c.Categoria] || 0) + (Number(c.value) || 0) }), {});
            
            const monthlySpending = processedData.filter(d => d.isCost).reduce((a, c) => {
                const month = `${c.date.getFullYear()}-${(c.date.getMonth() + 1).toString().padStart(2, '0')}`;
                return {...a, [month]: (a[month] || 0) + (Number(c.value) || 0) };
            }, {});

            const fuelStops = {};
            processedData.filter(d => d.Categoria === 'Gasolina').forEach(d => {
                const dateStr = d.Data;
                if (!fuelStops[dateStr]) fuelStops[dateStr] = { date: d.date };
                if (d.Chave === 'Quilometragem') fuelStops[dateStr].km = d.value;
                if (d.Chave === 'Valor total') fuelStops[dateStr].totalValue = d.value;
                if (d.Chave === 'Valor do litro') fuelStops[dateStr].pricePerLiter = d.value;
            });
            const validFuelStops = Object.values(fuelStops).filter(d => d.km && d.totalValue && d.pricePerLiter && d.km < 20000).sort((a, b) => a.date - b.date);
            
            const consumptionData = [];
            for (let i = 1; i < validFuelStops.length; i++) {
                const dist = validFuelStops[i].km - validFuelStops[i - 1].km;
                const liters = validFuelStops[i].totalValue / validFuelStops[i].pricePerLiter;
                if (dist > 0 && liters > 0) {
                    const kpl = dist / liters;
                    if (kpl > 10 && kpl < 100) consumptionData.push({ date: validFuelStops[i].date, kpl });
                }
            }
            const avgConsumption = consumptionData.length > 0 ? consumptionData.reduce((a, c) => a + c.kpl, 0) / consumptionData.length : 0;
            document.getElementById('avg-consumption').innerHTML = `${formatNumber(avgConsumption, 1)} <span class="unit">km/L</span>`;

            const gasTotalCost = processedData.filter(d => d.Categoria === 'Gasolina' && d.Chave === 'Valor total').reduce((a, c) => a + (Number(c.value) || 0), 0);
            const gasTotalLiters = validFuelStops.reduce((a, c) => a + (c.totalValue / c.pricePerLiter), 0);
            document.getElementById('gas-total-cost').textContent = formatCurrency(gasTotalCost);
            document.getElementById('gas-total-liters').innerHTML = `${formatNumber(gasTotalLiters, 1)} <span class="unit">L</span>`;
            document.getElementById('gas-avg-price').textContent = formatCurrency(gasTotalCost / gasTotalLiters);

            const oleoCosts = processedData.filter(d => d.Categoria === '√ìleo' && d.Chave === 'Valor');
            const oleoKms = processedData.filter(d => d.Categoria === '√ìleo' && d.Chave === 'Quilometragem').sort((a, b) => a.date - b.date);
            const oleoTotalCost = oleoCosts.reduce((a, c) => a + (Number(c.value) || 0), 0);
            const kmDiffs = [];
            for (let i = 1; i < oleoKms.length; i++) kmDiffs.push(oleoKms[i].value - oleoKms[i - 1].value);
            const oleoAvgKm = kmDiffs.length > 0 ? kmDiffs.reduce((a, b) => a + b, 0) / kmDiffs.length : 0;
            document.getElementById('oleo-total-cost').textContent = formatCurrency(oleoTotalCost);
            document.getElementById('oleo-count').textContent = oleoCosts.length;
            document.getElementById('oleo-avg-cost').textContent = formatCurrency(oleoTotalCost / oleoCosts.length);
            document.getElementById('oleo-avg-km').innerHTML = `${formatNumber(oleoAvgKm, 0)} <span class="unit">km</span>`;
            const oleoTableBody = document.getElementById('oleo-table-body');
            oleoKms.forEach((entry, i) => {
                const kmSinceLast = i > 0 ? entry.value - oleoKms[i - 1].value : null;
                let row = oleoTableBody.insertRow();
                row.insertCell(0).textContent = entry.Data;
                row.insertCell(1).textContent = `${formatNumber(entry.value, 1)} km`;
                row.insertCell(2).textContent = kmSinceLast ? `${formatNumber(kmSinceLast, 1)} km` : 'Primeira troca registrada';
            });
            
            const infracoes = Object.values(processedData.filter(d => d.Categoria === 'Infra√ß√£o').reduce((a, c) => ({...a, [c.Data]: { ...a[c.Data], [c.Chave]: c.value, Data: c.Data } }), {}));
            document.getElementById('infracao-total-cost').textContent = formatCurrency(infracoes.reduce((a, c) => a + (Number(c.Valor) || 0), 0));
            document.getElementById('infracao-count').textContent = infracoes.length;
            document.getElementById('infracao-total-pontos').textContent = infracoes.reduce((a, c) => a + (parseInt(c.Pontos) || 0), 0);
            infracoes.forEach(i => { let r=document.getElementById('infracoes-table-body').insertRow(); r.insertCell(0).textContent=i.Data;r.insertCell(1).textContent=i.Motivo;r.insertCell(2).textContent=i.Tipo;r.insertCell(3).textContent=i.Pontos;r.insertCell(4).textContent=formatCurrency(i.Valor); });
            
            const outrosData = processedData.filter(d => d.Categoria === 'Outros');
            document.getElementById('outros-total-cost').textContent = formatCurrency(outrosData.reduce((a, c) => a + (Number(c.value) || 0), 0));
            const top10Outros = outrosData.sort((a,b) => b.value - a.value).slice(0, 10);
            
            renderCharts(costsByCategory, monthlySpending, validFuelStops, consumptionData, top10Outros);
        }
        
        function renderCharts(costsByCategory, monthlySpending, validFuelStops, consumptionData, top10Outros) {
            const chartOptions = {
                chart: { fontFamily: 'Inter, sans-serif', toolbar: { show: false }, zoom: { enabled: false } },
                stroke: { width: 3, curve: 'smooth' },
                markers: { size: 0 },
                tooltip: { theme: 'light', x: { format: 'dd MMM yyyy' } },
                grid: { borderColor: '#e0e5e9', strokeDashArray: 4 },
                dataLabels: { enabled: false }
            };

            new ApexCharts(document.querySelector("#category-chart"), { ...chartOptions, series: Object.values(costsByCategory), labels: Object.keys(costsByCategory), chart: { ...chartOptions.chart, type: 'donut' }, legend: { position: 'bottom' } }).render();

            const sortedMonths = Object.keys(monthlySpending).sort();
            new ApexCharts(document.querySelector("#monthly-spending-chart"), { ...chartOptions, series: [{ name: 'Gastos', data: sortedMonths.map(m => monthlySpending[m]) }], chart: { ...chartOptions.chart, type: 'area', height: 350 }, colors: [chartOptions.accent_color], xaxis: { type: 'category', categories: sortedMonths }, yaxis: { labels: { formatter: val => formatCurrency(val) } }, tooltip: { ...chartOptions.tooltip, y: { formatter: val => formatCurrency(val) } } }).render();

            new ApexCharts(document.querySelector("#fuel-price-chart"), { ...chartOptions, series: [{ name: 'Valor/litro', data: validFuelStops.map(d => [d.date.getTime(), d.pricePerLiter]) }], chart: { ...chartOptions.chart, type: 'line', height: 350 }, colors: ['#f39c12'], xaxis: { type: 'datetime' }, yaxis: { labels: { formatter: val => formatCurrency(val) } }, tooltip: { ...chartOptions.tooltip, y: { formatter: val => formatCurrency(val) } } }).render();
            
            new ApexCharts(document.querySelector("#fuel-consumption-chart"), { ...chartOptions, series: [{ name: 'Km/L', data: consumptionData.map(d => [d.date.getTime(), d.kpl]) }], chart: { ...chartOptions.chart, type: 'area', height: 350 }, colors: ['#2ecc71'], xaxis: { type: 'datetime' }, yaxis: { labels: { formatter: val => formatNumber(val, 1) } }, tooltip: { ...chartOptions.tooltip, y: { formatter: val => `${formatNumber(val, 1)} Km/L` } } }).render();

            new ApexCharts(document.querySelector("#outros-top-chart"), { ...chartOptions, series: [{ name: 'Custo', data: top10Outros.map(i => i.value) }], chart: { ...chartOptions.chart, type: 'bar', height: 350 }, plotOptions: { bar: { borderRadius: 4, horizontal: true } }, xaxis: { categories: top10Outros.map(i => i.Chave), labels: { formatter: val => formatCurrency(val) } }, tooltip: { y: { formatter: val => formatCurrency(val) } } }).render();
        }
    </script>
</body>
</html>
