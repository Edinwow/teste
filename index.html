<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Gastos ‚Äî Moto üèçÔ∏è</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbfdfe; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --accent:#2563eb;
      font-family: 'Inter', system-ui, -apple-system, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:flex-start;gap:16px}
    h1{font-size:20px;margin:0;font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    nav.tabs{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap}
    button.tab{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button.tab.active{background:var(--card);box-shadow:0 6px 18px rgba(16,24,40,0.06);border-color:rgba(37,99,235,0.12);color:var(--accent)}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .card.metrics{display:flex;gap:12px;align-items:center}
    .metric{flex:1}
    .metric .k{font-weight:700;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    canvas{width:100% !important;height:300px !important}
    .content{margin-top:14px}
    .center{display:flex;align-items:center;justify-content:center}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.card.metrics{flex-direction:column;align-items:flex-start}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üèçÔ∏è Painel de Gastos ‚Äî Moto</h1>
        <div class="sub">Minimalista ‚Äî uma p√°gina por categoria. Fonte: Google Sheets (CSV)</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="muted">Fonte:</div>
        <div style="font-weight:600">Google Sheets</div>
        <div id="status" class="muted" style="margin-top:6px">Carregando‚Ä¶</div>
      </div>
    </header>

    <nav class="tabs card" id="tabs" aria-label="Categorias"></nav>

    <main class="content">
      <!-- container das p√°ginas -->
      <div id="pages"></div>
    </main>

    <footer>‚ú® Dica: se abrir localmente e o CSV n√£o carregar por CORS, baixe o CSV e abra este arquivo no navegador.</footer>
  </div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXYUEcvzBEg1AQ5754QmQUGb73zVzI6LEI-WmdAxHx1N2_5ZGLPP0DobNZQW1-IUk1qZVOiu0SZ965/pub?gid=817947441&single=true&output=csv';
let data = [];
let categories = [];
let charts = {};

function parseNumber(v){
  if(v==null) return NaN;
  v = String(v).trim().replace(/\./g,'').replace(/,/g,'.').replace(/R\$|\s/g,'');
  const n = parseFloat(v);
  return isNaN(n)?NaN:n;
}

function load(){
  document.getElementById('status').textContent = 'Buscando CSV‚Ä¶';
  Papa.parse(CSV_URL, {download:true, header:true, skipEmptyLines:true, complete: (res)=>{
    data = res.data.map(r=>({
      Categoria:(r.Categoria||r.categoria||'').trim(),
      Data:(r.Data||r.data||'').trim(),
      Chave:(r.Chave||r.chave||'').trim(),
      Valor:(r.Valor||r.valor||'').trim()
    }));
    document.getElementById('status').textContent = 'Dados carregados';
    process();
  }, error:(err)=>{document.getElementById('status').textContent = 'Erro ao carregar CSV'} });
}

function toDate(d){
  if(!d) return null;
  // dd/mm/yyyy
  if(/\d{2}\/\d{2}\/\d{4}/.test(d)){
    const [dd,mm,yy] = d.split('/'); return new Date(`${yy}-${mm}-${dd}T00:00:00`);
  }
  const t = Date.parse(d); return isNaN(t)?null:new Date(t);
}

function process(){
  data.forEach(r=>{ r._date = toDate(r.Data); r._valor = parseNumber(r.Valor); });
  data = data.filter(r=>r.Categoria && r._date);
  categories = Array.from(new Set(data.map(d=>d.Categoria))).sort();
  if(categories.length===0){ document.getElementById('status').textContent='Nenhuma categoria encontrada'; return; }
  renderTabs();
  // open first category
  openCategory(categories[0]);
}

function renderTabs(){
  const tabs = document.getElementById('tabs'); tabs.innerHTML='';
  categories.forEach((c,idx)=>{
    const btn = document.createElement('button'); btn.className='tab'; btn.textContent = (idx===0? '‚ú® ':'') + c; btn.onclick = ()=>openCategory(c);
    btn.setAttribute('data-cat',c);
    tabs.appendChild(btn);
  });
}

function clearActiveTab(){
  document.querySelectorAll('button.tab').forEach(b=>b.classList.remove('active'));
}

function openCategory(cat){
  clearActiveTab();
  const btn = document.querySelector(`button.tab[data-cat="${cat}"]`); if(btn) btn.classList.add('active');
  const entries = data.filter(d=>d.Categoria===cat && isFinite(d._valor));
  const allEntries = data.filter(d=>d.Categoria===cat);
  renderPage(cat, entries, allEntries);
}

function monthKey(d){ return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }

function aggregateMonthly(entries){
  const map = new Map();
  entries.forEach(e=>{
    const k = monthKey(e._date);
    map.set(k, (map.get(k)||0) + (isFinite(e._valor)?e._valor:0));
  });
  const arr = Array.from(map.entries()).sort();
  return arr.map(([k,v])=>({month:k, value:Math.round(v*100)/100}));
}

function renderPage(cat, entries, allEntries){
  const pages = document.getElementById('pages'); pages.innerHTML='';
  // header metrics
  const total = entries.reduce((s,e)=>s + (isFinite(e._valor)?e._valor:0),0);
  const months = new Set(entries.map(e=>monthKey(e._date)));
  const avgMonth = months.size? total / months.size : 0;
  const count = entries.length;

  const container = document.createElement('div');
  container.className='page';

  const metricsCard = document.createElement('div'); metricsCard.className='card metrics';
  // metrics
  const m1 = document.createElement('div'); m1.className='metric'; m1.innerHTML = '<div class=\"muted\">Total gasto</div><div class=\"k\">'+fmt(total)+'</div>';
  const m2 = document.createElement('div'); m2.className='metric'; m2.innerHTML = '<div class=\"muted\">M√©dia mensal</div><div class=\"k\">'+fmt(avgMonth)+'</div>';
  const m3 = document.createElement('div'); m3.className='metric'; m3.innerHTML = '<div class=\"muted\">Registros</div><div class=\"k\">'+count+'</div>';
  metricsCard.appendChild(m1); metricsCard.appendChild(m2); metricsCard.appendChild(m3);

  // charts grid
  const grid = document.createElement('div'); grid.className='grid';
  const lineCard = document.createElement('div'); lineCard.className='card'; lineCard.innerHTML = '<div class="muted">üìà Evolu√ß√£o mensal</div><canvas id="line-'+escapeId(cat)+'"></canvas>';
  const barCard = document.createElement('div'); barCard.className='card'; barCard.innerHTML = '<div class="muted">üìä Barras por m√™s</div><canvas id="bar-'+escapeId(cat)+'"></canvas>';
  const tableCard = document.createElement('div'); tableCard.className='card'; tableCard.innerHTML = '<div class="muted">√öltimos registros</div><div id="list-'+escapeId(cat)+'" style="margin-top:8px;font-size:13px"></div>';

  grid.appendChild(lineCard); grid.appendChild(barCard); grid.appendChild(tableCard);

  container.appendChild(metricsCard); container.appendChild(grid);
  pages.appendChild(container);

  // populate list
  const listEl = document.getElementById('list-'+escapeId(cat));
  const last = allEntries.slice().sort((a,b)=>b._date - a._date).slice(0,8);
  listEl.innerHTML = last.map(l=> `${l.Data} ‚Äî ${l.Chave || ''} <strong style="float:right">${isFinite(l._valor)?fmt(l._valor):''}</strong>`).join('<hr style="border:none;border-top:1px solid #f1f5f9;margin:8px 0">');

  // build monthly series (keep months continuous)
  const monthly = aggregateMonthly(allEntries.filter(e=>isFinite(e._valor)));
  const labels = monthly.map(m=>formatMonth(m.month));
  const values = monthly.map(m=>m.value);

  // ensure charts destroyed
  const lineId = 'line-'+escapeId(cat); const barId = 'bar-'+escapeId(cat);
  if(charts[lineId]) charts[lineId].destroy(); if(charts[barId]) charts[barId].destroy();

  // create line
  const ctx1 = document.getElementById(lineId).getContext('2d');
  charts[lineId] = new Chart(ctx1, {
    type:'line', data:{ labels, datasets:[{ label:'Gasto (R$)', data:values, fill:true, tension:0.36, pointRadius:3, borderWidth:2, borderColor:alphaColor('--accent',0.95), backgroundColor:alphaColor('--accent',0.12) }] },
    options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{ticks:{callback: v=>fmt(v)}} }, responsive:true, maintainAspectRatio:false }
  });

  // create bar
  const ctx2 = document.getElementById(barId).getContext('2d');
  charts[barId] = new Chart(ctx2, {
    type:'bar', data:{ labels, datasets:[{ label:'Gasto (R$)', data:values, borderRadius:6, borderSkipped:false, backgroundColor:alphaColor('--accent',0.18), borderColor:alphaColor('--accent',0.28), borderWidth:1 }] },
    options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{display:false}}, y:{ticks:{callback: v=>fmt(v)}} }, responsive:true, maintainAspectRatio:false }
  });
}

function escapeId(s){ return s.replace(/[^a-z0-9]/gi,'_'); }
function fmt(n){ if(!isFinite(n)) return 'R$ 0,00'; return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function formatMonth(k){ const [y,m]=k.split('-'); const date = new Date(Number(y), Number(m)-1,1); return date.toLocaleString('pt-BR',{month:'short',year:'numeric'}); }

function alphaColor(varName, a){
  // read CSS variable
  const root = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  // fallback
  let hex = '#2563eb';
  if(root) hex = root;
  // convert hex to rgba
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

window.addEventListener('load',()=>{ load(); });
</script>
</body>
</html>
